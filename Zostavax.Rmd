---
title: "Zostavax immunization against herpes zoster, Kensington 2017-2018"
abstract: Herpes zoster (shingles) is a painful, debilitating and sometimes dangerous re-activation of varicella zoster virus. Immunization against herpes zoster reduces the occurrence of the disease. This project measures the proportion of eligible patients at the Kensington site vaccinated against herpes zoster over 2017-2018. A mechanism to further increase immunization coverage is proposed. The techniques used in this project are generalizable to other practice quality improvement activities.

author: 'David Fong'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(plotly)
```

### Synopsis and proposal

Shingles is a painful, debilitating and sometimes dangerous re-activation of varicella zoster virus. Although treatment is available for herpes zoster, particularly if detected early, immunization can reduce the risk of contracting the disease.

The currently available shingles vaccine in Australia, Zostavax, can reduce the incidence of herpes zoster in the 70-79 year year age group by 41%[^1].

[^1]: Australian Immunization Handbook - <https://immunisationhandbook.health.gov.au/vaccine-preventable-diseases/zoster-herpes-zoster>

Varicella immunization is recommended and funded by the Australian Government for people aged 70 years to reduce the risk of shingles (herpes zoster). Until 30 October 2021, a single catch-up dose is available for adults aged 71 to 79 years inclusive[^2].

[^2]: National Immunisation Program Schedule - https://beta.health.gov.au/health-topics/immunisation/immunisation-throughout-life/national-immunisation-program-schedule

The proportion of eligible 70-79 year olds who have been immunized against Zostavax has steadily increased to 50% of the target population at the Kensington site of coHealth, but [has been static from May to September 2019](#bp_proportion). Current [weekly immunization data](#dcp_proportion) has also been static at 50% since late 2018, suggesting that without additional measures the immunization proportion is unlikely to significantly improve.

As approximately 50% of eligible patients each week seen at the practice leave without a record of immunization, it is proposed that patients booked in each day are identified for potential Zostavax immunization eligibility.

A [Best Practice SQL script](SQLnovax) which identifies non-immunized eligible patients is [presented at the end of this document](SQLnovax). It is proposed to identify patients at the beginning of each day for a month and continue to evaluate the proportion of eligible patients immunized against shingles.

Modified variations of these tools can be used to identify patients for whom other health screening activities are recommended, and both measure and monitor practice performance in these activities. Examples include bowel cancer or cervical cancer screening, or early detection of chronic kidney disease among patients with diabetes.

### Data

Best Practice (up to September 2018) and PenCAT (up to June 2018) provide data of proportion of 'active' patients immunized against herpes zoster. Patients are defined as 'active' if they have three contacts over two years. Some 'contacts' may be trivial, e.g. correspondence and telephone contacts with third parties.

Weekly Doctor's Control panel (DCP) data, August 2017 to September 2018, provides data of proportion of contacted patients immunized against herpes zoster. DCP data is weekly contact data, where a contact is defined as where a billing has occurred.

Full data and analysis R-code can be found on [Github](https://github.com/DavidPatShuiFong/coHealthKensington/blob/master/Zostavax.Rmd).

```{r data, include=FALSE}

bp_report <- data.frame(Date = as.Date('2017/01/01'), Vaccinated = 27, Total = 199)

bp_report[nrow(bp_report)+1,] <- list(as.Date('2017/02/01'),36,196)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2017/03/01'),45,196)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2017/04/01'),50,193)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2017/05/01'),53,189)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2017/06/01'),59,190)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2017/07/01'),59,190)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2017/08/01'),59,189)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2017/09/01'),60,192)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2017/10/01'),63,190)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2017/11/01'),70,192)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2017/12/01'),74,187)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2018/01/01'),76,188)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2018/02/01'),81,189)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2018/03/01'),84,190)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2018/04/01'),90,191)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2018/05/01'),95,192)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2018/06/01'),97,189)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2018/07/01'),97,192)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2018/08/01'),97,193)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2018/09/01'),97,194)
bp_report[nrow(bp_report)+1,] <- list(as.Date('2018/10/01'),100,197)


pencat_report <- data.frame(Date = as.Date('2018/06/19'), Vaccinated = 98, Total = 204)
                            
pencat_report[nrow(pencat_report)+1,] <- list(as.Date('2018/05/18'),98,203)
pencat_report[nrow(pencat_report)+1,] <- list(as.Date('2018/04/18'),92,206)
pencat_report[nrow(pencat_report)+1,] <- list(as.Date('2018/03/16'),89,207)
pencat_report[nrow(pencat_report)+1,] <- list(as.Date('2018/02/10'),85,208)
pencat_report[nrow(pencat_report)+1,] <- list(as.Date('2017/12/28'),79,206)
pencat_report[nrow(pencat_report)+1,] <- list(as.Date('2017/12/01'),77,207)
pencat_report[nrow(pencat_report)+1,] <- list(as.Date('2017/11/03'),73,207)
pencat_report[nrow(pencat_report)+1,] <- list(as.Date('2017/10/03'),65,203)
pencat_report[nrow(pencat_report)+1,] <- list(as.Date('2017/09/05'),64,203)
pencat_report[nrow(pencat_report)+1,] <- list(as.Date('2017/08/01'),59,203)
pencat_report[nrow(pencat_report)+1,] <- list(as.Date('2017/07/06'),58,202)
pencat_report[nrow(pencat_report)+1,] <- list(as.Date('2017/04/21'),51,204)
pencat_report[nrow(pencat_report)+1,] <- list(as.Date('2017/03/17'),44,207)

dcp_report <- data.frame(Date =  as.Date('2017/08/13'), Proportion = 0.26)

dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/08/20'),0.19)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/08/27'),0.24)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/09/10'),0.42)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/09/17'),0.35)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/09/24'),0.34)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/10/01'),0.45)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/10/22'),0.44)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/10/29'),0.50)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/11/05'),0.48)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/11/12'),0.42)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/11/19'),0.57)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/12/03'),0.53)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/12/17'),0.75)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2017/12/31'),0.45)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/01/08'),0.51)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/01/22'),0.52)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/01/29'),0.37)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/02/12'),0.62)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/02/19'),0.46)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/02/26'),0.38)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/03/05'),0.45)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/03/12'),0.47)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/03/19'),0.53)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/03/26'),0.56)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/04/02'),0.56)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/04/16'),0.5)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/04/30'),0.59)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/05/07'),0.59)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/05/14'),0.55)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/05/21'),0.44)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/05/28'),0.62)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/06/11'),0.44)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/06/25'),0.46)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/07/02'),0.42)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/07/16'),0.62)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/07/30'),0.61)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/08/06'),0.45)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/08/20'),0.53)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/08/27'),0.62)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/09/03'),0.46)
dcp_report[nrow(dcp_report)+1,] <- list(as.Date('2018/09/10'),0.44)

```

### Plots

```{r cbindpad, include=FALSE}

cbindPad <- function(...){
  # version of cbind which pads empty rows with NA
  # written by 'joran', in answer to question on StackOverflow
  # https://stackoverflow.com/questions/6988184/combining-two-data-frames-of-different-lengths
  args <- list(...)
  n <- sapply(args,nrow)
  mx <- max(n)
  pad <- function(x, mx){
      if (nrow(x) < mx){
        nms <- colnames(x)
        padTemp <- matrix(NA, mx - nrow(x), ncol(x))
        colnames(padTemp) <- nms
        if (ncol(x)==0) {
          return(padTemp)
        } else {
        return(rbind(x,padTemp))
        }
      }
    else{
      return(x)
    }
  }
  rs <- lapply(args,pad,mx)
  return(do.call(cbind,rs))
}

``` 

#### Proportion of active patients immunized against shingles {#bp_proportion}

The proportion of active patients aged 70-79 years who have a record of shingles vaccination at each time period.

Main data source is extracted using [SQL code](SQLzno) in Best Practice[^3].

[^3]: Similar data is available from PenCAT, which is also plotted for comparison purposes. Accurate PenCAT data not available after June 2018, because PenCAT does not recognize varicella zoster immunization which had been migrated from one clinical software (Medical Director 3) to another (Best Practice). The clinical software migration occurred in June 2018.

Proportion of patients recorded as having been immunized steadily increased from less than 15% in January 2017 to 50% in May 2017.  Since May 2017, the proportion immunized has remained steady/flat at 50%.

```{r data_manipulate, include=FALSE}
pencat_report <- pencat_report %>%
  mutate(pencat_Proportion = Vaccinated/Total) %>%
  mutate(pencat_numericDate = as.numeric(Date)) %>%
  rename(pencat_Date = Date) %>%
  select(pencat_Proportion, pencat_Date, pencat_numericDate)

bp_report <- bp_report %>%
  mutate(Proportion = Vaccinated/Total) %>%
  mutate(numericDate = as.numeric(Date))

bp_report <- cbindPad(bp_report, pencat_report)
# adds pencat_report to bp_report
# uses defined function cbindPad (defined in previous code section)
# note that rows originating from pencat_report are not 'aligned'
# with the rows in bp_report, nor do they need to be...

```

```{r plot_bp, warning=FALSE, message=FALSE}

ml <- loess(Proportion ~ numericDate, data = bp_report)
m <- augment(ml) #loess localized regression accepts numbers, not dates
m$Date <- bp_report$Date # but plotly plots require, in this case, dates, not numbers!

ml_p <- loess(pencat_Proportion ~ pencat_numericDate, data = bp_report)
m_p <- augment(ml_p)
m_p$Date <- bp_report$pencat_Date[!is.na(bp_report$pencat_Date)]

p_bp <- bp_report %>%
  plot_ly(x = ~Date, y = ~Proportion,
          name = 'BP SQL data',
          type = 'scatter', mode = 'markers') %>%
  add_lines(y = ~fitted(ml), x = ~Date,
            line = list(color = 'rgba(7,164,181,1)'),
            showlegend = FALSE) %>%
  add_trace(x=~pencat_Date, y = ~pencat_Proportion,
            name = 'PenCAT data', type = 'scatter', mode = 'markers',
            marker = list(color = 'rgba(164,164,164,.5)')) %>%
  add_lines(y = ~fitted(ml_p), x = ~pencat_Date[!is.na(pencat_Date)],
            line = list(color = 'rgba(164,164,164,.5)', dash = 'dash'),
            showlegend = FALSE) %>%
  add_ribbons(data = m,
              x = ~Date,
              ymin = ~.fitted - 1.96 * .se.fit,
              ymax = ~.fitted + 1.96 * .se.fit,
              line = list(color = 'rgba(7,164,181,0.05)'),
              fillcolor = 'rgba(7,164,181,0.2)',
              showlegend = FALSE) %>% 
  layout(title = 'Varicella zoster vaccination
         proportion of 70-79 year olds (Best Practice report)
         coHealth Kensington, 2017-2018',
         legend = list(x = 0.75, y = 0.5)
)

link <- api_create(p_bp, filename = 'zostavax_coverage')
p_bp


```

#### Doctor's Control Panel weekly immunization data {#dcp_proportion}

Doctor's Control Panel (DCP) reports weekly immunization patient data, based on age-eligible (70-79 years old) patients seen each week.

Plot shows that by late 2017, 50% of age-eligible patients seen week had been or were vaccinated against varicella zoster.  This proportion has remained the same up to September 2017.

```{r plot_dcp, warning=FALSE, message=FALSE}

dcp_report$numericDate <- as.numeric(dcp_report$Date)
m <- augment(loess(Proportion ~ numericDate,
                   data = dcp_report))
m$Date <- dcp_report$Date

p_dcp <- dcp_report %>%
  plot_ly(x=~Date, y=~Proportion,
          type='scatter', mode='markers') %>%
  add_lines(y = ~fitted(loess(Proportion ~ as.numeric(Date))),
            line = list(color = 'rgba(7,164,181,1)'),
            showlegend = FALSE) %>%
  add_ribbons(data = m,
              x = ~Date,
              ymin = ~.fitted - 1.96 * .se.fit,
              ymax = ~.fitted + 1.96 * .se.fit,
              line = list(color = 'rgba(7,164,181,0.05)'),
              fillcolor = 'rgba(7,164,181,0.2)',
              showlegend = FALSE) %>% 
  layout(title = 'Varicella zoster vaccination
         proportion of 70-79 year olds
         seen in each week (DCP report)
         coHealth Kensington, 2017-2018')

link <- api_create(p_dcp, filename = 'zostavax_dcp')
p_dcp

```

### SQL code for Best Practice

#### Number of 'active' patients aged 70-79 years immunized against Zostavax {#SQLzno}

```{sql eval=FALSE}
SELECT *
FROM BPS_Patients

WHERE StatusText = 'Active'
AND DOB < DateAdd(Year,-70,'20181001')
AND DOB > DateAdd(Year,-80,'20181001')
-- age 70 to 80 years at specified date

AND InternalID IN (SELECT InternalID 
  FROM Visits v
  INNER JOIN (VALUES('%bhagwat%'),('%fong%'),('%ekanayake%'),('%shoesmith%'), 
             ('%plastow%'),('%samarawickrama%'),('%obeyesekere%'),('%chaves%'),
             ('%ryan%'),('%mikhail%'),('%haynes%'),('%buckwell%'),
             ('%grace ho%'))
             AS ProviderName(Name)
            ON v.DrName LIKE ProviderName.Name
            -- appointment with specified providers
  WHERE VisitDate >= DateAdd(Year,-2,'20181001')
  AND VisitDate < '20181001'
  -- visits during specified two year time period
  AND RecordStatus = 1
 
  GROUP BY internalid
  HAVING count(internalid) >= 3 
  -- minimum 3 visits during specified time period
  )
   
-- remove following condition for total eligible patient numbers
AND InternalID IN (SELECT InternalID 
  FROM Immunisations
  WHERE ((VaccineName LIKE '%zostavax%') OR (VaccineID=103))
  -- Zostavax immunization data migrated from Medical Director 3 to Best Practice
  -- did not migrate with VaccineIDs, and so is undetectable by PenCAT
  AND GivenDate < '20181001')

ORDER BY surname, firstname
```

#### Identify booked patients without record of Zostavax immunization {#SQLnovax}

```{sql eval=FALSE}
SELECT *
FROM BPS_Patients

WHERE StatusText = 'Active'
AND DOB < DateAdd(Year,-70,GetDate())
AND DOB > DateAdd(Year,-80,GetDate())
-- current age 70 to 80 years

AND InternalID IN (SELECT InternalID 
  FROM Appointments
  INNER JOIN (VALUES('%bhagwat%'),('%fong%'),('%ekanayake%'),('%shoesmith%'), 
             ('%plastow%'),('%samarawickrama%'),('%obeyesekere%'),('%chaves%'),
             ('%ryan%'),('%mikhail%'),('%haynes%'),('%buckwell%'),
             ('%grace ho%'),('%bullen%'),('%lambrou%'),('%zeigler%')) AS providers(Name)
             ON dbo.BPSPayee(UserID) LIKE providers.Name
             -- appointment with specified providers

  WHERE AppointmentDate = '20180927'
  -- appointment on specified date
  AND RecordStatus = 1
  )

AND InternalID NOT IN (SELECT InternalID
  FROM Immunisations 
  WHERE VaccineName LIKE '%zostavax%')

ORDER BY surname, firstname
```