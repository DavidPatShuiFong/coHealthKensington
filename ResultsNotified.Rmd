---
title: "Results notified, coHealth Kensington, 2015-2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(plotly)
```

## Data definition

Data extracted from Medical Director

* **Period** - Time of data extract
* **ResultAge** - Age of results. If the age of the result is 0-1 weeks, the **ResultAge** is recorded as '1'. If the age of the result is 1-2 weeks, the **ResultAge** is recorded as '2', and so on.
* **NotNotified** - The number of results not notified of the specified **ResultAge**, at the time of **Period**
* **Notified** - The number of results notified of the specified **ResultAge**, at the time of **Period**

```{r data}

discuss <- data.frame(Period = 'Jul 2015', ResultAge = 1, NotNotified = 88, Notified = 16)
discuss <- rbind(discuss, data.frame(Period = 'Jul 2015', ResultAge = 2, NotNotified = 79,Notified = 35))
discuss <- rbind(discuss, data.frame(Period = 'Jul 2015', ResultAge = 3, NotNotified = 81,Notified = 52))
discuss <- rbind(discuss, data.frame(Period = 'Jul 2015', ResultAge = 4, NotNotified = 30,Notified = 45))
discuss <- rbind(discuss, data.frame(Period = 'Jul 2015', ResultAge = 5, NotNotified = 25,Notified = 43))
discuss <- rbind(discuss, data.frame(Period = 'Jul 2015', ResultAge = 6, NotNotified = 36,Notified = 51))
discuss <- rbind(discuss, data.frame(Period = 'Jul 2015', ResultAge = 7, NotNotified = 14,Notified = 53))
discuss <- rbind(discuss, data.frame(Period = 'Jul 2015', ResultAge = 8, NotNotified = 22,Notified = 96))
discuss <- rbind(discuss, data.frame(Period = 'Jul 2015', ResultAge = 9, NotNotified = 31,Notified = 71))
discuss <- rbind(discuss, data.frame(Period = 'Jul 2015', ResultAge = 10, NotNotified = 21,Notified = 56))
discuss <- rbind(discuss, data.frame(Period = 'Jul 2015', ResultAge = 11, NotNotified = 31,Notified = 94))
discuss <- rbind(discuss, data.frame(Period = 'Jul 2015', ResultAge = 12, NotNotified = 26,Notified = 72))

discuss <- rbind(discuss, data.frame(Period = 'Mar 2017', ResultAge = 1, NotNotified = 86,Notified = 15))
discuss <- rbind(discuss, data.frame(Period = 'Mar 2017', ResultAge = 2, NotNotified = 41,Notified = 20))
discuss <- rbind(discuss, data.frame(Period = 'Mar 2017', ResultAge = 3, NotNotified = 26,Notified = 37))
discuss <- rbind(discuss, data.frame(Period = 'Mar 2017', ResultAge = 4, NotNotified = 75,Notified = 44))
discuss <- rbind(discuss, data.frame(Period = 'Mar 2017', ResultAge = 5, NotNotified = 42,Notified = 51))
discuss <- rbind(discuss, data.frame(Period = 'Mar 2017', ResultAge = 6, NotNotified = 23,Notified = 64))
discuss <- rbind(discuss, data.frame(Period = 'Mar 2017', ResultAge = 7, NotNotified = 43,Notified = 73))
discuss <- rbind(discuss, data.frame(Period = 'Mar 2017', ResultAge = 8, NotNotified = 38,Notified = 40))
discuss <- rbind(discuss, data.frame(Period = 'Mar 2017', ResultAge = 9, NotNotified = 30,Notified = 69))
discuss <- rbind(discuss, data.frame(Period = 'Mar 2017', ResultAge = 10, NotNotified = 47,Notified = 91))
discuss <- rbind(discuss, data.frame(Period = 'Mar 2017', ResultAge = 11, NotNotified = 47,Notified = 52))
discuss <- rbind(discuss, data.frame(Period = 'Mar 2017', ResultAge = 12, NotNotified = 11,Notified = 10))

discuss <- rbind(discuss, data.frame(Period = 'Jun 2017', ResultAge = 1, NotNotified = 63,Notified = 4))
discuss <- rbind(discuss, data.frame(Period = 'Jun 2017', ResultAge = 2, NotNotified = 49,Notified = 33))
discuss <- rbind(discuss, data.frame(Period = 'Jun 2017', ResultAge = 3, NotNotified = 47,Notified = 36))
discuss <- rbind(discuss, data.frame(Period = 'Jun 2017', ResultAge = 4, NotNotified = 41,Notified = 44))
discuss <- rbind(discuss, data.frame(Period = 'Jun 2017', ResultAge = 5, NotNotified = 38,Notified = 74))
discuss <- rbind(discuss, data.frame(Period = 'Jun 2017', ResultAge = 6, NotNotified = 22,Notified = 42))
discuss <- rbind(discuss, data.frame(Period = 'Jun 2017', ResultAge = 7, NotNotified = 45,Notified = 77))
discuss <- rbind(discuss, data.frame(Period = 'Jun 2017', ResultAge = 8, NotNotified = 18,Notified = 23))
discuss <- rbind(discuss, data.frame(Period = 'Jun 2017', ResultAge = 9, NotNotified = 26,Notified = 42))
discuss <- rbind(discuss, data.frame(Period = 'Jun 2017', ResultAge = 10, NotNotified = 38,Notified = 39))
discuss <- rbind(discuss, data.frame(Period = 'Jun 2017', ResultAge = 11, NotNotified = 34,Notified = 64))
discuss <- rbind(discuss, data.frame(Period = 'Jun 2017', ResultAge = 12, NotNotified = 26,Notified = 39))

discuss <- rbind(discuss, data.frame(Period = 'Sep 2017', ResultAge = 1, NotNotified = 96,Notified = 32))
discuss <- rbind(discuss, data.frame(Period = 'Sep 2017', ResultAge = 2, NotNotified = 68,Notified = 41))
discuss <- rbind(discuss, data.frame(Period = 'Sep 2017', ResultAge = 3, NotNotified = 96,Notified = 51))
discuss <- rbind(discuss, data.frame(Period = 'Sep 2017', ResultAge = 4, NotNotified = 85,Notified = 49))
discuss <- rbind(discuss, data.frame(Period = 'Sep 2017', ResultAge = 5, NotNotified = 91,Notified = 52))
discuss <- rbind(discuss, data.frame(Period = 'Sep 2017', ResultAge = 6, NotNotified = 91,Notified = 47))
discuss <- rbind(discuss, data.frame(Period = 'Sep 2017', ResultAge = 7, NotNotified = 78,Notified = 65))
discuss <- rbind(discuss, data.frame(Period = 'Sep 2017', ResultAge = 8, NotNotified = 82,Notified = 85))
discuss <- rbind(discuss, data.frame(Period = 'Sep 2017', ResultAge = 9, NotNotified = 55,Notified = 108))
discuss <- rbind(discuss, data.frame(Period = 'Sep 2017', ResultAge = 10, NotNotified = 62,Notified = 88))
discuss <- rbind(discuss, data.frame(Period = 'Sep 2017', ResultAge = 11, NotNotified = 69,Notified = 99))
discuss <- rbind(discuss, data.frame(Period = 'Sep 2017', ResultAge = 12, NotNotified = 45,Notified = 76))

```

## Calculate proportions

Calculate proportion of results not notified and store in **ProportionNotNotified**.

``` {r calculations}

discuss$ProportionNotNotified <- discuss$NotNotified/(discuss$Notified+discuss$NotNotified)

```

## Plot

Including fitted localized regression line (Loess), with
1.96 * Standard error (95% confidence interval) ribbons.

```{r plot}

m <- augment(loess(ProportionNotNotified ~ ResultAge,
                   data = discuss))

discuss %>%
  plot_ly(x=~ResultAge, y=~ProportionNotNotified, color=discuss$Period, opacity=0.25, 
          type='scatter', mode='lines') %>%
  add_lines(y = ~fitted(loess(ProportionNotNotified ~ ResultAge)),
            line = list(color = 'rgba(7,164,181,1)'),
            showlegend = FALSE) %>%
  add_ribbons(data = m,
              x = ~ResultAge,
              ymin = ~.fitted - 1.96 * .se.fit,
              ymax = ~.fitted + 1.96 * .se.fit,
              line = list(color = 'rgba(7,164,181,0.05)'),
              fillcolor = 'rgba(7,164,181,0.2)',
              showlegend = FALSE) %>% 
  layout(title = "Proportion of Results not Notified
         (Results having been marked 'Discuss')
         coHealth Kensington, 2015-2017",
         xaxis = list(title = 'Age of result in weeks'),
         yaxis = list(title = 'Proportion of results not notified'))


```
