---
title: "Daily View"
author: "David Fong"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    includes:
      in_header: 'semantic_ui.html'
    
runtime: shiny

---

```{r global, setup, include=FALSE}
library(flexdashboard)
library(tidyverse)

library(dbplyr) # database interaction for dplyr
library(DBI)    # R database interface
library(odbc)   # the database backend handler for Microsoft SQL Server
library(pool)   # database pool

library(base64enc)  # simple obfuscation for passwords
library(DT)         # pretty-print tables/tibbles
library(lubridate)  # time handling library

# database setup

filename <- 'BestPracticeSQL_password.txt'
dbpassword <- rawToChar(base64decode(readChar(filename,file.info(filename)$size)))
  # obfuscated, NOT ENCRYPTED, password
  # password file created with command like
  #    cat(base64encode(charToRaw('mypassword')), file="BestPracticeSQL_password.txt")

pool <- dbPool(odbc::odbc(), driver = "SQL Server", server = "127.0.0.1\\BPSINSTANCE", 
                      database = "BPSSamples", uid = "bpsrawdata", pwd = dbpassword)

practice_locations <- as.tibble(read.csv('PracticeLocations.csv'))
  # two columns : 'Fullname' and 'Location'

# database table setup

users <- pool %>% 
  tbl(in_schema('dbo', 'BPS_Users')) %>% 
  select(c('UserID', 'Surname', 'Firstname', 'LocationName', 'Title')) %>%
  collect() %>%     # forces database to be read (instead of subsequent 'lazy' read)
  mutate(Title = trimws(Title), Firstname = trimws(Firstname), Surname = trimws(Surname)) %>%
  mutate(Fullname = paste(Title, Firstname, Surname, sep = ' ')) %>%
  left_join(practice_locations) %>%   # add practice locations imported from external CSV file
  filter(!is.na(Location))            # only include users which have a defined practice location

locations <- rbind(tibble(Location = 'All'), practice_locations %>% select(c('Location')) %>% unique()) 
  # add 'All' to (unique) locations list

patients <- pool %>%
  tbl(in_schema('dbo', 'BPS_Patients'))

investigations <- pool %>%            
  tbl(in_schema('dbo', 'BPS_Investigations')) %>%
  select(c('InternalID', 'Collected', 'TestName'))
  # as of Jan/2019, the odbc engine for MSSQL can't handle the full ('Select *') Investigations table
  # due to some type of bug/standards non-compliance. also can handle the History table. need to
  # 'Select' out just a few columns.

correspondenceIn <- pool %>%
  tbl(in_schema('dbo', 'BPS_CorrespondenceIn')) %>%
  select(c('InternalID', 'CorrespondenceDate', 'Subject', 'Detail'))

reportValues <- pool %>%
  tbl(in_schema('dbo', 'BPS_ReportValues')) %>%
  select(c('InternalID', 'ReportDate', 'ResultName', 'LoincCode'))

invoices <- pool %>%
  tbl(in_schema('dbo', 'INVOICES')) %>%
  select(c('InternalID', 'INVOICEID', 'INVOICEDATE'))

services <- pool %>%
  tbl(in_schema('dbo', 'BPS_SERVICES'))

# function setup

# fomantic (semantic.ui) string functions

semantic_tag <- function(tag, colour="") {
  paste0('<span class="huge ', colour, ' ui tag label">', tag, '</span>', sep = "") 
  # paste0 is vectorized version of 'paste'
}

```

Inputs {.sidebar}
-----------------------------------------------------------------------

### Appointment Date Range

```{r}

wellPanel(
  dateInput('date1', label = 'From:', format='DD dd/M/yyyy', min = Sys.Date()-4000, max = Sys.Date()+180),
  dateInput('date2', label = 'To:', format='DD dd/M/yyyy', min = Sys.Date()-4000, max = Sys.Date()+180),
  actionButton('update_date', 'Update', icon('refresh'), class = 'btn btn-primary'),
  helpText("After adjusting the date range, click the 'Update' button",
           "to adjust the viewed appointment date range")
)
```

### Clinician list

```{r}
wellPanel(
  selectInput('location', 'Practice location', locations, selected = 'All'),
  uiOutput('clinicianList')
)

```

```{r}
# 'helper' functions for input panel

# only adjust appointment view after dates are 'submitted'
date_a <- eventReactive(input$update_date, {
  input$date1
})
date_b <- eventReactive(input$update_date, {
  input$date2
})

# list of clinicians shown depends on 'practice location' chosen
output$clinicianList <- renderUI({
  choice_list <- if (input$location == 'All') users$Fullname else users[users$Location == input$location,]$Fullname
    # note that 'ifelse' only returns result in the same 'shape' as the comparison statement
  chosen_list <- input$clinicians # retain previous selections
  checkboxGroupInput('clinicians', 'Clinician', choices = choice_list, selected = chosen_list)
})

```

```{r}
# 'helper' functions for calculation

calc_age <- function(birthDate, refDate = Sys.Date()) {
  # Calculate age at a given reference date
  # Create an interval between the date of birth and the enrollment date; 
  # intervals are specific to the two dates. Periods give the actual length
  # of time between those dates, so convert to period and extract the year.
  # written by 'mmparker' https://gist.github.com/mmparker/7254445

  period <- as.period(interval(birthDate, refDate),                        
                      unit = "year")
  period$year
}
```

Row {.tabset}
-----------------------------------------------------------------------

### Target Age

```{r}

bowel_cancer_screen_terms <- c("(VALUES('%FOB%'), ('%OCCULT%'), ('%FAECAL HUMAN HAEMOGLOBIN%'),
                               ('%OCB NATIONAL SCREENING%'), ('%FHB%'), ('%FAECAL BLOOD%'),
                               ('%FAECAL IMMUNOCHEMICAL TEST%'), ('%FAECAL HAEMOGLOBIN%'),
                               ('%COLONOSCOPY%'), ('%COLONOSCOPE%')) AS tests(fobtnames)")

fobt_investigation_query <- paste('SELECT InternalID, Collected, TestName FROM dbo.BPS_Investigations
                                    INNER JOIN', bowel_cancer_screen_terms,
                                    'ON TestName LIKE tests.fobtnames')
    # SQL code to find investigations which could be bowel cancer screening items

fobt_letter_subject_query <- paste('SELECT InternalID, CorrespondenceDate, Subject FROM dbo.BPS_CorrespondenceIn
                                   INNER JOIN', bowel_cancer_screen_terms,
                                  'ON Subject LIKE tests.fobtnames')

fobt_letter_detail_query <- paste('SELECT InternalID, CorrespondenceDate, Detail FROM dbo.BPS_CorrespondenceIn
                                  INNER JOIN', bowel_cancer_screen_terms,
                                  'ON Detail LIKE tests.fobtnames')

fobt_result_query <- paste("SELECT InternalID, ReportDate, ResultName FROM dbo.BPS_ReportValues 
                           WHERE LoincCode IN ('2335-8','27396-1','14563-1','14564-9','14565-6',
                         	                     '12503-9','12504-7','27401-9','27925-7','27926-5',
	                                             '57905-2','56490-6','56491-4','29771-3')")

screen_fobt_list <- reactive({
  appointments() %>%
    left_join(patients, by = 'InternalID', copy = TRUE) %>%   # need patients database to access date-of-birth
    select(c('Patient', 'InternalID', 'AppointmentDate', 'AppointmentTime', 'Provider', 'DOB')) %>% 
    mutate(DOB = substr(DOB, 1, 10)) %>%
    mutate(Age = calc_age(DOB)) %>%
    filter(DOB<=ymd(Sys.Date())-years(50) & DOB>ymd(Sys.Date())-years(75)) # from age 50 to 75 years inclusive
})

screen_fobt_ix <- reactive({
  left_join(screen_fobt_list(),
            bind_rows(inner_join(screen_fobt_list(),
                                 dbGetQuery(pool, fobt_investigation_query) %>% collect() %>%
                                   rename(TestDate = Collected),
                                 by = 'InternalID'),
                      inner_join(screen_fobt_list(),
                                 dbGetQuery(pool, fobt_letter_subject_query) %>% collect() %>%
                                   rename(TestDate = CorrespondenceDate, TestName = Subject),
                                 by = 'InternalID'),
                      inner_join(screen_fobt_list(),
                                 dbGetQuery(pool, fobt_letter_detail_query) %>% collect() %>%
                                   rename(TestDate = CorrespondenceDate, TestName = Detail),
                                 by = 'InternalID'),
                      inner_join(screen_fobt_list(),
                                 dbGetQuery(pool, fobt_result_query) %>% collect() %>%
                                   rename(TestDate = ReportDate, TestName = ResultName),
                                 by = 'InternalID')
                      ) %>%
              mutate(TestDate = as.Date(substr(TestDate, 1, 10))) %>%  # remove time from date
              group_by(InternalID) %>% # group by patient ID (need most recent investigation for each patient)
              filter(TestDate == max(TestDate, na.rm = TRUE)  # only keep the latest(/recent) dated investigation
           )
  )
})

renderDT({datatable(screen_fobt_ix() %>%
                      mutate(OutOfDateTest = case_when(is.na(TestDate) ~ 0, # if no date (no detected test)
                                                       TestDate<(Sys.Date()-730) ~ 1,  # 1 if old
                                                       TRUE ~ 2)),                    # 2 if up-to-date
                    options=list(columnDefs = list(list(visible=FALSE,  # very clunky way to hide 'OutOfDate' column
                                                        targets=c(length(names(screen_fobt_ix()))+1)))),
                    fillContainer = TRUE) %>%
    formatStyle(
      columns = 'TestDate',
      valueColumns = 'OutOfDateTest',       # unfortunately, datatables cannot compare dates directly for styling
      color = styleEqual(c(0, 1, 2), c('red', 'red', 'black')),
      backgroundColor = styleEqual(c(0, 1, 2), c('red', 'yellow', 'green'))
    )
})


```

### Billing

```{r}

# collects ALL billings for patients who have displayed appointments
appointments_billings <- reactive({
  appointments() %>%
    left_join(services, by = c('InternalID' = 'INTERNALID'), copy=TRUE) %>%
    collect() %>%
    mutate(SERVICEDATE = as.Date(substr(SERVICEDATE, 1, 10)))
  })

# filter to billings which are done on the same day as displayed appointments
appointments_billings_sameday <- reactive({
  appointments_billings() %>%
    filter(SERVICEDATE == AppointmentDate) %>%    # billings done on the same day as displayed appointments
    select(c('InternalID', 'AppointmentDate', 'MBSITEM')) %>%
    mutate(MBSITEM = semantic_tag(MBSITEM, colour = 'green')) %>%
      # change MBSITEMS into fomantic/semantic tags
    group_by(InternalID, AppointmentDate) %>%     # gathers item numbers on the same day into a single row
    summarise(Billings = paste(MBSITEM, collapse = "")) %>%
    ungroup()
  })

renderDT({datatable(appointments() %>%
                      left_join(appointments_billings_sameday(), by = c('InternalID', 'AppointmentDate')) %>%
                      select(c('Patient', 'AppointmentDate', 'AppointmentTime', 'Provider', 'Status', 'Billings')),
                    escape = c(TRUE, TRUE, TRUE, TRUE, TRUE, FALSE), # only interpret HTML for last column
                    fillContainer = TRUE)
  })

```


### Appointments

```{r}

hrmin <- function(t) {
  # converts seconds to a 'time' starting from midnight
  # t : value in seconds
  # returns 24-hour time of form '14:15' (hh:mm)
  td <- seconds_to_period(t)
  sprintf('%02d:%02d', td@hour, td@minute)
}

appointments <- reactive({
  validate (
    need(input$clinicians, 'Choose at least one clinician appointment to view'),
    need(date_a(), 'Invalid date range'),
    need(date_b(), 'Invalid date range')
  )
  pool %>% 
    tbl(in_schema('dbo', 'BPS_Appointments')) %>%
    filter(AppointmentDate >= local(date_a()) & AppointmentDate <= local(date_b())) %>%
    filter(Provider %in% input$clinicians) %>% 
      # note that dbplyr does not evaluate manipulated expressions, hence the use of 'local()'
      # a database filter on an empty list after %in% will result in an error message
    select(c('Patient', 'InternalID', 'AppointmentDate', 'AppointmentTime', 'Provider', 'Status')) %>%
    collect() %>% # force read of database
    mutate(AppointmentTime = hrmin(AppointmentTime), AppointmentDate = substr(AppointmentDate,1,10)) %>%
    arrange(AppointmentDate, AppointmentTime)
})

renderDT({datatable(
  appointments() %>%
    select(c('Patient', 'AppointmentDate', 'AppointmentTime', 'Provider', 'Status')),
  fillContainer = TRUE
  )})

```
